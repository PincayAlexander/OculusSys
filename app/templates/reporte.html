{% extends "layout/base.html" %}

{% block title %}Dashboard - Reportes{% endblock %}

{% block stylesheets %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/reporte.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filtros.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard__header">

  <!-- Modal de exportación -->
  <div id="modalExportarArchivo" class="modal__background" aria-hidden="true">
    <div class="modal modal--small modal__exportararchivo">
      <!-- Botón cerrar -->
      <button class="modal__close" onclick="cerrarModal('modalExportarArchivo')">
        <div class="svg-src" data-src="cerrar"></div>
      </button>

      <h4>Exportar archivo</h4>
      <form id="formExportarArchivo">
        <!-- Nombre del archivo -->
        <div class="modal__group">
          <input class="modal__input" type="text" name="nombreArchivo" placeholder=" " required>
          <label class="modal__label">Nombre del archivo</label>
        </div>

        <!-- Rango de fechas -->
        <div class="modal__group">
          <input class="modal__input" type="date" name="fechaInicio" required>
          <label class="modal__label">Fecha inicio</label>
        </div>
        <div class="modal__group">
          <input class="modal__input" type="date" name="fechaFin" required>
          <label class="modal__label">Fecha fin</label>
        </div>

        <!-- Selección de formato -->
        <div class="modal__group">
          <label class="modal__label" style="top:0;transform:none;position:relative;">Formato</label>
          <div class="modal__buttons">
            <button type="button" class="btn formato" data-formato="ppt">PPT</button>
            <button type="button" class="btn formato" data-formato="xls">XLS</button>
            <button type="button" class="btn formato" data-formato="pdf">PDF</button>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal__footer">
          <button type="button" class="btn btn__primary" id="btnExportarArchivo">Exportar</button>
          <button type="button" class="btn btn__secondary" onclick="cerrarModal('modalExportarArchivo')">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <h2>Reporte Mensual de Plagas</h2>

  <div class="options__header">
    <div class="dropdown__filtro">
      <button class="btn btn__secondary dropdown__filtro--button">
        <div class="svg-src" data-src="filter"></div>
        Filtros
      </button>
      <div class="dropdown__menu dropdown__menu--filtro">
        <!-- Filtro de Parcelas -->
        <div class="filtros__grupo">
          <label for="filtroParcelas" class="filtros__etiqueta">Parcela</label>
          <select id="filtroParcelas" class="filtros__select">
            <option value="todas">Todas</option>
            <option value="parcela-a">Parcela A</option>
            <option value="parcela-b">Parcela B</option>
            <option value="parcela-c">Parcela C</option>
          </select>
        </div>

        <!-- Filtro de Áreas -->
        <div class="filtros__grupo">
          <label for="filtroAreas" class="filtros__etiqueta">Área</label>
          <select id="filtroAreas" class="filtros__select">
            <option value="todas">Todas</option>
            <option value="area-1">Área 1</option>
            <option value="area-2">Área 2</option>
            <option value="area-3">Área 3</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Filtro de Fechas -->
    <div class="filtro-icono">
      <label for="filtroFecha" class="filtros__etiqueta">Fechas</label>
      <div class="input-con-icono">
        <input type="text" id="filtroFecha" placeholder="Selecciona un rango">
        <div class="svg-src" data-src="calendar"></div>
      </div>
    </div>

    <!-- Botón corregido para abrir el modal correcto -->
    <button class="btn btn__primary" onclick="abrirModal('modalExportarArchivo')">
      <div class="svg-src" data-src="exportar"></div>
      Descargar
    </button>

  </div>
</div>

<div class="dashboard">
  <div class="side card">
    <h5>Áreas Monitoreadas</h5>
    <ul>
      <li>Parcela 1 - Presencia de Roya</li>
      <li>Parcela 2 - Presencia de Mildiu</li>
      <li>Parcela 3 - Sana</li>
      <li>Parcela 4 - Sana</li>
      <li>Parcela 5 - Presencia de Mancha de hierro</li>
      <li>Parcela 6 - Sana</li>
    </ul>
  </div>

  <div class="graphics__section">
    <div class="card__section--top">
      <div class="section-medidas">
        <div class="card">
          <h5>🟡 Cantidad de Controlado</h5>
          <div id="controlado" class="progress-text" style="color: green">247</div>
        </div>

        <div class="card">
          <h5>% de Plagas Controlado</h5>
          <canvas id="gaugeControlado"></canvas>
        </div>

        <div class="card">
          <h5>🔺 Cantidad de Detecciones</h5>
          <div id="detecciones" class="progress-text" style="color: red">330</div>
        </div>

        <div class="card">
          <h5>% de Plagas Sin Controlar</h5>
          <canvas id="gaugeSinControlar"></canvas>
        </div>
      </div>

      <div class="seccion-grafica">
        <div class="card">
          <h5>Tipos de Plagas Detectadas</h5>
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </div>

    <div class="section-bottom">
      <div class="top-bar">
        <h5>Cantidad de Detecciones vs Controles</h5>
      </div>
      <canvas id="lineChart"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Primero el modal.js para que las funciones estén disponibles -->
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
<!-- Después el reporte.js que usa esas funciones -->
<script src="{{ url_for('static', filename='js/reporte.js') }}"></script>

<!-- jsPDF y html2canvas para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- PptxGenJS para exportar a PowerPoint -->
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.10.0/dist/pptxgen.bundle.js"></script>
{% endblock %}
